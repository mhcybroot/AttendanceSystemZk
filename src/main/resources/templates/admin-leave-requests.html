<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Manage Leave Requests</title>
</head>

<body>
    <div th:replace="~{layout :: layout(~{::section}, ~{::script}, 'leave-manage')}">
        <section>
            <div
                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2" th:text="${pageTitle != null ? pageTitle : 'Leave Requests Management'}">Leave Requests
                    Management</h1>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Employee</th>
                                    <th>Dates</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Proof</th>
                                    <th>Reviewer</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="req : ${requests}">
                                    <td>
                                        <div class="fw-bold" th:text="${req.employee.name}">John Doe</div>
                                        <small class="text-muted"
                                            th:text="${req.employee.department != null ? req.employee.department.name : 'No Dept'}">IT</small>
                                    </td>
                                    <td>
                                        <div th:text="${req.leaveType}" class="badge bg-secondary mb-1">VACATION</div>
                                        <br>
                                        <small th:text="${req.startDate} + ' to ' + ${req.endDate}"></small>
                                    </td>
                                    <td>
                                        <span th:text="${req.reason}" class="text-truncate d-inline-block"
                                            style="max-width: 200px;">Reason...</span>
                                    </td>
                                    <td>
                                        <span class="badge"
                                            th:classappend="${req.status.name() == 'APPROVED' ? 'bg-success' : (req.status.name() == 'REJECTED' ? 'bg-danger' : 'bg-warning text-dark')}"
                                            th:text="${req.status}">PENDING</span>
                                    </td>
                                    <td>
                                        <a th:if="${req.proofPath != null}" th:href="@{${req.proofPath}}"
                                            target="_blank" class="btn btn-sm btn-outline-info" title="View Proof">
                                            <i class="fas fa-paperclip"></i>
                                        </a>
                                        <span th:if="${req.proofPath == null}" class="text-muted">-</span>
                                    </td>
                                    <td>
                                        <small th:if="${req.adminComment != null}">
                                            <div th:text="${req.reviewedBy}">Admin</div>
                                            <i class="text-muted" th:text="${req.adminComment}"></i>
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-secondary me-1"
                                            th:onclick="viewRequest([[${req.employee.name}]], [[${req.employee.department != null ? req.employee.department.name : 'No Dept'}]], [[${req.leaveType}]], [[${req.startDate} + ' to ' + ${req.endDate}]], [[${req.reason}]], [[${req.status}]], [[${req.proofPath}]])"
                                            title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        <!-- Actions only available if Pending OR if User is Admin (Override) -->
                                        <!-- HR Constraint: Can only edit PENDING -->
                                        <div class="d-inline-block"
                                            th:if="${req.status.name() == 'PENDING' or #authorization.expression('hasRole(''ADMIN'')')}">
                                            <button class="btn btn-sm btn-success me-1" data-bs-toggle="modal"
                                                data-bs-target="#actionModal" th:data-id="${req.id}"
                                                data-action="APPROVED" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                                data-bs-target="#actionModal" th:data-id="${req.id}"
                                                data-action="REJECTED" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>

                                        <!-- Testing Option: Delete -->
                                        <div th:if="${isTestingMode}" class="d-inline-block ms-2">
                                            <form action="/leave/manage/delete" method="post"
                                                onsubmit="return confirm('TESTING MODE: Delete this request irreversibly?');">
                                                <input type="hidden" name="id" th:value="${req.id}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    title="Delete (Testing)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${requests.isEmpty()}">
                                    <td colspan="6" class="text-center text-muted py-4">No leave requests found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Modal -->
            <div class="modal fade" id="actionModal" tabindex="-1">
                <div class="modal-dialog">
                    <form action="/leave/manage/update" method="post">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" name="id" id="modalRequestId">
                                <input type="hidden" name="status" id="modalActionStatus">
                                <p id="modalMessage">Are you sure?</p>
                                <div class="mb-3">
                                    <label class="form-label">Comment (Required for Rejection)</label>
                                    <textarea name="comment" class="form-control" rows="2"
                                        placeholder="Reason..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Confirm</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View Details Modal -->
            <div class="modal fade" id="viewModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Leave Request Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h5 id="viewName" class="mb-1">John Doe</h5>
                            <p class="text-muted small mb-3" id="viewDept">Department</p>

                            <dl class="row">
                                <dt class="col-sm-4">Leave Type:</dt>
                                <dd class="col-sm-8"><span class="badge bg-secondary" id="viewType">TYPE</span></dd>

                                <dt class="col-sm-4">Dates:</dt>
                                <dd class="col-sm-8" id="viewDates">Jan 1 - Jan 2</dd>

                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8" id="viewStatus">PENDING</dd>

                                <dt class="col-sm-4 mt-2">Reason:</dt>
                                <dd class="col-sm-12 mt-1 p-3 bg-light rounded" id="viewReason">
                                    Full reason text...
                                </dd>

                                <dt class="col-sm-4 mt-2">Proof:</dt>
                                <dd class="col-sm-8 mt-2" id="viewProofContainer">
                                    <!-- Link will be injected here -->
                                </dd>
                            </dl>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <script>
            const actionModal = document.getElementById('actionModal')
            actionModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget
                const id = button.getAttribute('data-id')
                const action = button.getAttribute('data-action')

                const modalRequestId = actionModal.querySelector('#modalRequestId')
                const modalActionStatus = actionModal.querySelector('#modalActionStatus')
                const modalMessage = actionModal.querySelector('#modalMessage')

                modalRequestId.value = id
                modalActionStatus.value = action
                modalMessage.textContent = `Are you sure you want to mark this request as ${action}?`
            })

            function viewRequest(name, dept, type, dates, reason, status, proofPath) {
                document.getElementById('viewName').textContent = name;
                document.getElementById('viewDept').textContent = dept;
                document.getElementById('viewType').textContent = type;
                document.getElementById('viewDates').textContent = dates;
                document.getElementById('viewReason').textContent = reason;
                document.getElementById('viewStatus').textContent = status;

                const proofContainer = document.getElementById('viewProofContainer');
                proofContainer.innerHTML = '';
                if (proofPath) {
                    const link = document.createElement('a');
                    link.href = proofPath;
                    link.target = '_blank';
                    link.textContent = 'View Attached Document';
                    link.className = 'btn btn-sm btn-primary';
                    proofContainer.appendChild(link);
                } else {
                    proofContainer.textContent = 'No attachment';
                }

                new bootstrap.Modal(document.getElementById('viewModal')).show();
            }
        </script>
    </div>
</body>

</html>